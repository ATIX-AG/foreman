<%#
kind: snippet
name: or_deb_client
model: ProvisioningTemplate
snippet: true
%>
<%
  if !host_param("or_client_repo_url").nil?
    or_client_repo_url = host_param("or_client_repo_url")
  elsif !host_param("or_#{@host.operatingsystem.name.downcase}_client_repo_prefix").nil?
    or_client_repo_url = host_param("or_#{@host.operatingsystem.name.downcase}_client_repo_prefix") + @host.operatingsystem.major.gsub('.', '_')
  else
    or_client_repo_url = nil
  end
%>
<%- if @host.operatingsystem.family == 'Debian' -%>
echo "Installing or_deb_client repository"
  <%- if or_client_repo_url.nil? -%>
echo "================================= Warning ============================================="
echo "Warning: To provision Debian clients, you need to prepare an 'or_deb_client'-repository"
echo "  and write it's location in the global parameter 'or_<%= @host.operatingsystem.name.downcase %>_client_repo_prefix'."
echo "================================= Warning ============================================="
  <%- end -%>

echo "Ensure gnupg is installed, which is needed for interacting with 'apt-key'"
apt-get update
apt-get -y install gnupg

echo "Install orcharhino repositories"
mkdir -p /etc/apt/trusted.gpg.d
wget "http://<%= foreman_server_fqdn %>/pub/pulp_deb_signing.key" -O - | apt-key add -
mkdir -p /etc/apt/sources.list.d

  <%- if host_param('kt_activation_keys') -%>

cat > /etc/apt/sources.list.d/orcharhino.list <<'EOF'
# This File is automatically generated.
# !!! Do not edit !!!

deb <%= or_client_repo_url %> stable main
EOF

apt-get update
apt-get -y install apt-transport-katello katello-upload-profile python-subscription-manager

echo "Remove all repositories from /etc/apt/sources.list{,.d/*}"
cat > /etc/apt/sources.list <<'EOF'
# This system is managed by orcharhino
EOF

find /etc/apt/sources.list.d -type f -print0 | xargs -r0 rm

echo "Registering the System"
wget --no-check-certificate -O - <%= foreman_server_url %>/pub/katello-rhsm-consumer | /bin/bash -x 2> /root/katello-rhsm-consumer.log
subscription-manager register --org="<%= @host.rhsm_organization_label %>" --name="<%= @host.name %>" --activationkey="<%= host_param('kt_activation_keys') %>"

  <%- else -%>

cat > /etc/apt/sources.list.d/orcharhino.list <<'EOF'
# This File is automatically generated.
# !!! Do not edit !!!
<%-
  i=1
  while host_param('or_deb_repo_%i' % (i))
-%>
deb http://<%= foreman_server_fqdn %>/<%= host_param('or_deb_repo_%i' % (i)) %>
<%-
  i = i + 1
end
-%>
EOF

  <%- end -%>
# Update the package lists and upgrade all packages
apt-get -y update
apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -y upgrade
<%- else -%>
echo "Warning! This should only be used on Debian OSes."
<%- end -%>
