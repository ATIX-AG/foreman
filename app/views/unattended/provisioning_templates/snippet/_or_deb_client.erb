<%#
kind: snippet
name: or_deb_client
model: ProvisioningTemplate
snippet: true
%>
<%
  content_facet = host_content_facet(@host)
%>
<%
  if !host_param("or_client_repo_url").nil?
    or_client_repo_url = host_param("or_client_repo_url")
  elsif !host_param("or_#{@host.operatingsystem.name.downcase}_client_repo_prefix").nil?
    or_client_repo_url = host_param("or_#{@host.operatingsystem.name.downcase}_client_repo_prefix") + @host.operatingsystem.major.gsub('.', '_')
  else
    or_client_repo_url = nil
  end
  if content_facet && content_facet.content_source_name
    host_content_fqdn = content_facet.content_source_name
    host_content_url = "https://"+content_facet.content_source_name
  else
    host_content_fqdn = foreman_server_fqdn
    host_content_url = foreman_server_url
  end
  if !host_param('http-proxy').nil?
    http_proxy = host_param('http-proxy')
    if !host_param('http-proxy-port').nil?
      http_proxy_port = host_param('http-proxy-port')
    else
      http_proxy_port = "3129"
    end
  end
  if !host_param('http-proxy-user').nil? && !host_param('http-proxy-password').nil?
    http_proxy_user = host_param('http-proxy-user')
    http_proxy_password = host_param('http-proxy-password')
    proxy_uri = http_proxy ? "http://#{http_proxy_user}:#{http_proxy_password}@#{http_proxy}:#{http_proxy_port}" : nil
  else
    proxy_uri = http_proxy ? "http://#{http_proxy}:#{http_proxy_port}" : nil
  end
%>

<%- if @host.operatingsystem.family == 'Debian' -%>
echo "Installing or_deb_client repository"

  <%- if or_client_repo_url.nil? -%>
echo "================================= Warning ============================================="
echo "Warning: To provision Debian clients, you need to prepare an 'or_deb_client'-repository"
echo "  and write it's location in the global parameter 'or_<%= @host.operatingsystem.name.downcase %>_client_repo_prefix'."
echo "================================= Warning ============================================="
  <%- end -%>

  <%- if !content_facet || !content_facet.content_source_name -%>
echo "================================= Warning ============================================="
echo " No content source found. Setting default to <%= foreman_server_fqdn %>"
echo "================================= Warning ============================================="
  <%- end -%>


  <% if proxy_uri -%>
# Add http proxy to apt
echo 'Acquire::http::Proxy "<%= proxy_uri %>";' >> /etc/apt/apt.conf.d/proxy.conf
echo 'Acquire::http::Proxy::<%= @preseed_server.split(":")[0] %> "DIRECT";' >> /etc/apt/apt.conf.d/proxy.conf

# Add http proxy to wget
echo 'use_proxy=yes' >> /etc/wgetrc
echo 'http_proxy=<%= proxy_uri %>' >> /etc/wgetrc
echo 'https_proxy=<%= proxy_uri %>' >> /etc/wgetrc
  <% end -%>

echo "Ensure gnupg is installed, which is needed for interacting with 'apt-key'"
apt-get update
apt-get -y install gnupg

echo "Install orcharhino repositories"
mkdir -p /etc/apt/trusted.gpg.d
wget "http://<%= host_content_fqdn %>/pub/pulp_deb_signing.key" -O - | apt-key add -
mkdir -p /etc/apt/sources.list.d

  <%- if host_param('kt_activation_keys') -%>

cat > /etc/apt/sources.list.d/orcharhino.list <<'EOF'
# This File is automatically generated.
# !!! Do not edit !!!

deb <%= or_client_repo_url %> default all
EOF

apt-get update
apt-get -y install apt-transport-katello katello-upload-profile

echo "Remove all repositories from /etc/apt/sources.list{,.d/*}"
cat > /etc/apt/sources.list <<'EOF'
# This system is managed by orcharhino
EOF

find /etc/apt/sources.list.d -type f -print0 | xargs -r0 rm

echo "Registering the System"
wget --no-check-certificate -O - <%= host_content_url %>/pub/katello-rhsm-consumer | /bin/bash -x 2> /root/katello-rhsm-consumer.log

<% if http_proxy %>
  subscription-manager config --server.proxy_hostname='<%= http_proxy %>'
  <% if http_proxy_user %>
    subscription-manager config --server.proxy_user='<%= http_proxy_user %>'
  <% end %>
  <% if http_proxy_password %>
    subscription-manager config --server.proxy_password='<%= http_proxy_password %>'
  <% end %>
  subscription-manager config --server.proxy_port='<%= http_proxy_port %>'
<% end %>

subscription-manager register --org="<%= @host.rhsm_organization_label %>" --name="<%= @host.name %>" --activationkey="<%= host_param('kt_activation_keys') %>"

# Update the package lists and upgrade all packages
apt-get -y update
apt-get -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" -y upgrade
  <%- else -%>

cat > /etc/apt/sources.list.d/orcharhino.list <<'EOF'
# This File is automatically generated.
# !!! Do not edit !!!
<%-
  i=1
  while host_param('or_deb_repo_%i' % (i))
-%>
deb http://<%= host_content_fqdn %>/<%= host_param('or_deb_repo_%i' % (i)) %>
<%-
  i = i + 1
end
-%>
EOF

  <%- end -%>
<%- else -%>
echo "Warning! This should only be used on Debian OSes."
<%- end -%>
